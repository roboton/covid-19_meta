---
title: "COVID-19 Exploratory"
output:
  html_notebook:
    code_folding: hide
    theme: lumen
  html_document:
    df_print: paged
---

[Github repo](https://github.com/roboton/covid-19_meta)

```{r setup}
knitr::opts_chunk$set(message = FALSE, error = FALSE)

library(tidyverse)
library(rvest)
library(magrittr)
library(lubridate)
```

# Understanding our data sources

## John Hopkins CSSE

Daily confirmed cases, deaths and recoveries broken down by country/region and state/province, when state/province is available.

```{r}
confirmed_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv")) %>%
  gather(date, confirmed, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))
deaths_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv")) %>%
  gather(date, deaths, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))
recovered_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv")) %>%
  gather(date, recovered, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))

(joined <- confirmed_ts %>%
   left_join(deaths_ts) %>%
   left_join(recovered_ts) %>%
   gather(stat, value, confirmed, deaths, recovered) %>%
   arrange(`Country/Region`, `Province/State`, date, stat)) %>%
  sample_frac(1.0)
```
```{r}
#' Prepares data.frame for plotting by aggregating, weighting, reordering, 
#' and filtering by location.
#'
#' @param geo_level column name to aggregate (sum) by
#' @param dcr_wts weights to order locations; vector of c(deaths, confirmed, recovered)
#' @param show_top_n show top n locations ordered by dcr_wts
#'
#' @return an aggregated, reordered, and filtered by location data.frame
#'
#' @examples
#' plot_prep("Country/Region", c(100, 1, -1), show_top_n = 25)
#'
#' @export
plot_prep <- function(df, geo_level = "Country/Region", dcr_wts = c(1, 0, 0),
                      show_top_n = 10) {
  df %>%
    mutate(location = !!sym(geo_level)) %>%
    # aggregate by location
    group_by(location, date, stat) %>%
    summarise(value = sum(value)) %>%
    ungroup() %>%
    # location order
    group_by(location) %>%
    mutate(
      total_wt =
        value[which(date == max(date) & stat == "deaths")] * dcr_wts[1] +
        value[which(date == max(date) & stat == "confirmed")] * dcr_wts[2] +
        value[which(date == max(date) & stat == "recovered")] * dcr_wts[3]
    ) %>%
    ungroup() %>%
    mutate(total_rank = dense_rank(desc(total_wt))) %>%
    # filter top n
    filter(total_rank %in% 1:show_top_n) %>%
    # order by rank
    mutate(location = fct_reorder(location, total_rank)) 
}
```

# Cross-country comparison {.tabset .tabset-fade .tabset-pills}

```{r}
#' Convenience function to plot country comparisons
plot_country_comps <- function(df) {
  df %>% 
    ggplot(aes(date, value, color=location)) +
    geom_line() + facet_wrap(vars(stat), ncol=1, scales = "free_y") +
    theme(legend.position = "right", legend.title = element_blank()) +
    xlab(element_blank())
}
```


## Top countries

```{r fig.height = 6}
joined %>%
  plot_prep("Country/Region") %>%
  plot_country_comps()
```

## excl China

```{r fig.height = 6}
joined %>%
  filter(!`Country/Region` %in%  c("China")) %>%
  plot_prep("Country/Region") %>%
  plot_country_comps()
```

## excl Italy, Iran, South Korea

```{r fig.height = 6}
joined %>%
  filter(!`Country/Region` %in%  c("China", "Italy", "Iran", "Korea, South")) %>%
  plot_prep("Country/Region") %>%
  plot_country_comps()
```

## excl Spain, France

```{r fig.height = 6}
joined %>%
  filter(!`Country/Region` %in%  c("China", "Italy", "Iran", "Korea, South",
                                   "Spain", "France")) %>%
  plot_prep("Country/Region") %>%
  plot_country_comps()
```

# Comparing growth {.tabset .tabset-fade .tabset-pills}

```{r}
#' Convenience function to plot growth comparisons
plot_growth_comps <- function(df, geo_level, dcr_wts = c(1, 0, 0),
                              show_top_n = 10) {
  df %>%
    plot_prep(geo_level, dcr_wts, show_top_n) %>%
    ggplot(aes(date, value)) + geom_line() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    facet_wrap(
      vars(location, stat), scales="free_y", ncol = 3,
      labeller=label_wrap_gen(multi_line=FALSE)) +
    theme(strip.background = element_blank(), legend.position = "None") +
    xlab(element_blank())
}
```

## By country

```{r, fig.width=9, fig.height=15}
joined %>% plot_growth_comps("Country/Region", show_top_n = 10)
```

## China

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "China") %>%
  plot_growth_comps("Province/State", show_top_n=10)
```

## US

```{r, fig.width=9, fig.height=18}
joined %>%
  filter(`Country/Region` == "US") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```

## Canada

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "Canada") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```

## Australia

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "Australia") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```

# Total deaths since first death {.tabset .tabset-fade .tabset-pills}

## 10 days since first death
```{r fig.width = 8}
joined %>%
  group_by(`Country/Region`) %>%
  mutate(total_deaths = sum(value * (stat == "deaths"))) %>%
  filter(total_deaths > 0 ) %>%
  #filter(`Country/Region` != "China") %>%
  plot_prep("Country/Region", show_top_n = 10) %>%
  arrange(location, stat, date) %>%
  group_by(location) %>%
  mutate(first_death_date = date[which(value != 0 & stat == "deaths")][1]) %>%
  mutate(`Days since first death` = date - first_death_date) %>%
  filter(stat == "deaths" & value > 0 & `Days since first death` <= 10) %>%
  ggplot(aes(`Days since first death`, value, color=location)) + geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # facet_wrap(
  #   vars(location, stat), scales="free_y", ncol = 1,
  #   labeller=label_wrap_gen(multi_line=FALSE)) +
  theme(strip.background = element_blank(), legend.position = "right",
        legend.title = element_blank()) +
  ylab("Total deaths")
```

## 30 days since first death
```{r fig.width = 8}
joined %>%
  group_by(`Country/Region`) %>%
  mutate(total_deaths = sum(value * (stat == "deaths"))) %>%
  filter(total_deaths > 0 ) %>%
  #filter(`Country/Region` != "China") %>%
  plot_prep("Country/Region", show_top_n = 10) %>%
  arrange(location, stat, date) %>%
  group_by(location) %>%
  mutate(first_death_date = date[which(value != 0 & stat == "deaths")][1]) %>%
  mutate(`Days since first death` = date - first_death_date) %>%
  filter(stat == "deaths" & value > 0 & `Days since first death` <= 30) %>%
  ggplot(aes(`Days since first death`, value, color=location)) + geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # facet_wrap(
  #   vars(location, stat), scales="free_y", ncol = 1,
  #   labeller=label_wrap_gen(multi_line=FALSE)) +
  theme(strip.background = element_blank(), legend.position = "right",
        legend.title = element_blank()) +
  ylab("Total deaths")
```

## 90 days since first death

```{r fig.width = 8}
joined %>%
  group_by(`Country/Region`) %>%
  mutate(total_deaths = sum(value * (stat == "deaths"))) %>%
  filter(total_deaths > 0 ) %>%
  #filter(`Country/Region` != "China") %>%
  plot_prep("Country/Region", show_top_n = 10) %>%
  arrange(location, stat, date) %>%
  group_by(location) %>%
  mutate(first_death_date = date[which(value != 0 & stat == "deaths")][1]) %>%
  mutate(`Days since first death` = date - first_death_date) %>%
  filter(stat == "deaths" & value > 0 & `Days since first death` <= 90) %>%
  ggplot(aes(`Days since first death`, value, color=location)) + geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # facet_wrap(
  #   vars(location, stat), scales="free_y", ncol = 1,
  #   labeller=label_wrap_gen(multi_line=FALSE)) +
  theme(strip.background = element_blank(), legend.position = "right",
        legend.title = element_blank()) +
  ylab("Total deaths")
```

# Doubling days