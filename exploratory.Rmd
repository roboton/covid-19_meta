---
title: "COVID-19 Exploratory"
output:
  html_notebook:
    code_folding: hide
    theme: lumen
  html_document:
    df_print: paged
---

[Github repo](https://github.com/roboton/covid-19_meta)

```{r setup}
knitr::opts_chunk$set(message = FALSE, error = FALSE)

library(tidyverse)
library(rvest)
library(magrittr)
library(lubridate)
```

# Understanding our data sources

## John Hopkins CSSE

Daily confirmed cases, deaths and recoveries broken down by country/region and state/province, when state/province is available.

```{r}
confirmed_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv")) %>%
  gather(date, confirmed, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))
deaths_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv")) %>%
  gather(date, deaths, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))
recovered_ts <- read_csv(url("https://raw.githubusercontent.com/roboton/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv")) %>%
  gather(date, recovered, -`Province/State`, -`Country/Region`, -Lat, -Long) %>%
  mutate(date = mdy(date))

(joined <- confirmed_ts %>%
   left_join(deaths_ts) %>%
   left_join(recovered_ts) %>%
   gather(stat, value, confirmed, deaths, recovered) %>%
   arrange(`Country/Region`, `Province/State`, date, stat))
```

# Cross-country comparison {.tabset .tabset-fade .tabset-pills}

## Top countries

```{r}
geo_level <- "Country/Region"
dcr_wts <- c(1, 0, 0)
show_top_n <- 10

joined %>%
  mutate(location = !!sym(geo_level)) %>%
  # aggregate by location
  group_by(location, date, stat) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  # location order
  mutate(total_wt = case_when(
    stat == "deaths" ~ dcr_wts[1] * value,
    stat == "confirmed" ~ dcr_wts[2] * value,
    stat == "recovered" ~ dcr_wts[3] * value
  )) %>%
  add_count(location, wt = total_wt, name = "total") %>%
  mutate(total_rank = dense_rank(desc(total))) %>%
  # filter top n
  filter(total_rank %in% 1:show_top_n) %>%
  # order by rank
  mutate(location = fct_reorder(location, total_rank)) %>%
  ggplot(aes(date, value, color=location)) +
  geom_line() + facet_wrap(vars(stat), ncol=1, scales = "free_y") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  xlab(element_blank())
```

## sans China

```{r}
geo_level <- "Country/Region"
dcr_wts <- c(1, 0, 0)
show_top_n <- 10

joined %>%
  mutate(location = !!sym(geo_level)) %>%
  # aggregate by location
  group_by(location, date, stat) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  # location order
  mutate(total_wt = case_when(
    stat == "deaths" ~ dcr_wts[1] * value,
    stat == "confirmed" ~ dcr_wts[2] * value,
    stat == "recovered" ~ dcr_wts[3] * value
  )) %>%
  add_count(location, wt = total_wt, name = "total") %>%
  mutate(total_rank = dense_rank(desc(total))) %>%
  # filter top n
  filter(total_rank %in% 2:(show_top_n + 1)) %>%
  # order by rank
  mutate(location = fct_reorder(location, total_rank)) %>%
  ggplot(aes(date, value, color=location)) +
  geom_line() + facet_wrap(vars(stat), ncol=1, scales = "free_y") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  xlab(element_blank())
```

## sans Italy, Iran, South Korea

```{r}
geo_level <- "Country/Region"
dcr_wts <- c(1, 0, 0)
show_top_n <- 10

joined %>%
  mutate(location = !!sym(geo_level)) %>%
  # aggregate by location
  group_by(location, date, stat) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  # location order
  mutate(total_wt = case_when(
    stat == "deaths" ~ dcr_wts[1] * value,
    stat == "confirmed" ~ dcr_wts[2] * value,
    stat == "recovered" ~ dcr_wts[3] * value
  )) %>%
  add_count(location, wt = total_wt, name = "total") %>%
  mutate(total_rank = dense_rank(desc(total))) %>%
  # filter top n
  filter(total_rank %in% 5:(show_top_n + 4)) %>%
  # order by rank
  mutate(location = fct_reorder(location, total_rank)) %>%
  ggplot(aes(date, value, color=location)) +
  geom_line() + facet_wrap(vars(stat), ncol=1, scales = "free_y") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  xlab(element_blank())
```

## sans Spain, France

```{r}
geo_level <- "Country/Region"
dcr_wts <- c(1, 0, 0)
show_top_n <- 10

joined %>%
  mutate(location = !!sym(geo_level)) %>%
  # aggregate by location
  group_by(location, date, stat) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  # location order
  mutate(total_wt = case_when(
    stat == "deaths" ~ dcr_wts[1] * value,
    stat == "confirmed" ~ dcr_wts[2] * value,
    stat == "recovered" ~ dcr_wts[3] * value
  )) %>%
  add_count(location, wt = total_wt, name = "total") %>%
  mutate(total_rank = dense_rank(desc(total))) %>%
  # filter top n
  filter(total_rank %in% 7:(show_top_n + 6)) %>%
  # order by rank
  mutate(location = fct_reorder(location, total_rank)) %>%
  ggplot(aes(date, value, color=location)) +
  geom_line() + facet_wrap(vars(stat), ncol=1, scales = "free_y") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  xlab(element_blank())
```

# Examining growth {.tabset .tabset-fade .tabset-pills}

```{r}
plot_growth_comps <- function(df, geo_level, dcr_wts = c(1, 0, 0),
                              show_top_n = 20) {
  df %>%
    mutate(location = !!sym(geo_level)) %>%
    # aggregate by location
    group_by(location, date, stat) %>%
    summarise(value = sum(value)) %>%
    ungroup() %>%
    # location order
    mutate(total_wt = case_when(
      stat == "deaths" ~ dcr_wts[1] * value,
      stat == "confirmed" ~ dcr_wts[2] * value,
      stat == "recovered" ~ dcr_wts[3] * value
    )) %>%
    add_count(location, wt = total_wt, name = "total") %>%
    mutate(total_rank = dense_rank(desc(total))) %>%
    # filter top n
    filter(total_rank %in% 1:show_top_n) %>%
    # order by rank
    mutate(location = fct_reorder(location, total_rank)) %>%
    ggplot(aes(date, value)) + geom_line() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    facet_wrap(
      vars(location, stat), scales="free_y", ncol = 3,
      labeller=label_wrap_gen(multi_line=FALSE)) +
    theme(strip.background = element_blank(), legend.position = "None") +
    xlab(element_blank())
}
```

## By country

```{r, fig.width=9, fig.height=15}
joined %>% plot_growth_comps("Country/Region", show_top_n = 10)
```

## China

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "China") %>%
  plot_growth_comps("Province/State", show_top_n=10)
```

## US

```{r, fig.width=9, fig.height=18}
joined %>%
  filter(`Country/Region` == "US") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```

## Canada

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "Canada") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```

## Australia

```{r, fig.width=9, fig.height=15}
joined %>%
  filter(`Country/Region` == "Australia") %>%
  plot_growth_comps("Province/State", show_top_n = 10)
```
